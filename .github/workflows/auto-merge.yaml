name: Auto merge main into release branches
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create-and-merge-prs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v8
        id: create-pull-requests
        name: Create pull requests
        with:
          script: |
            const branches = await github.paginate(
              github.rest.repos.listBranches,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                }
            );
            const releaseBranches = branches.filter(branch => branch.name.startsWith('release'));
            const prNumbers = [];
            for (const branch of releaseBranches) {
              try {
                let pr = (await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `Merge branch 'main' into ${branch.name}`,
                  head: 'main',
                  base: branch.name,
                })).data;
                prNumbers.push(pr.number);
              } catch (error) {
                console.error(`Failed to create pull request for branch '${branch.name}': ${error.message}`);
              }
            }
            return prNumbers;
      - uses: actions/github-script@v8
        id: merge-pull-requests
        name: Merge pull requests
        with:
          script: |
            const prNumbers = ${{ steps.create-pull-requests.outputs.result }}
            const WAIT_INTERVAL_SECONDS = 10; // Wait interval between checks (seconds)
            const TIMEOUT_SECONDS = 180; // Total timeout duration (seconds)
            for (const prNumber of prNumbers) {
              let pr = (await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              })).data;
              let elapsedSeconds = 0;
              while (pr.mergeable === null) {
                if (elapsedSeconds >= TIMEOUT_SECONDS) {
                  console.log(`Timeout: mergeable state not determined after ${elapsedSeconds} seconds for PR #${prNumber}. Skipping to next PR.`);
                  break;
                }
                console.log('Waiting for mergeable state to be known');
                await new Promise(resolve => setTimeout(resolve, WAIT_INTERVAL_SECONDS * 1000));
                elapsedSeconds += WAIT_INTERVAL_SECONDS;
                pr = (await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                })).data;
              }
              if (pr.mergeable) {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });
              }
            }
